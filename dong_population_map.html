<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전국 행정동별 인구변화 지도</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .dong-point {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .dong-point:hover {
            stroke-width: 3;
            filter: brightness(1.2);
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .region-selector {
            max-height: 300px;
            overflow-y: auto;
        }
        .timeline-controls {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
        }
        .population-legend {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6">
        <!-- 헤더 -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🏘️ 전국 행정동별 인구변화 지도</h1>
            <p class="text-gray-600">3,497개 행정동 × 12년간(2014-2025) 인구변화 시각화</p>
            <div class="mt-4 flex justify-center space-x-6 text-sm">
                <span class="bg-blue-100 px-3 py-1 rounded">📍 3,497개 행정동</span>
                <span class="bg-green-100 px-3 py-1 rounded">📅 12년 시계열</span>
                <span class="bg-purple-100 px-3 py-1 rounded">🎯 실시간 분석</span>
            </div>
        </header>

        <!-- 컨트롤 패널 -->
        <div class="timeline-controls text-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 시간 컨트롤 -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">⏰ 시간 분석</h3>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <label class="text-sm font-medium">연도:</label>
                            <input type="range" id="yearSlider" min="2014" max="2025" value="2024" 
                                   class="flex-1" onchange="updateMapByYear(this.value)">
                            <span id="currentYear" class="text-lg font-bold">2024</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="playAnimation()" id="playBtn" class="px-4 py-2 bg-white bg-opacity-20 rounded hover:bg-opacity-30">
                                ▶️ 재생
                            </button>
                            <button onclick="resetMap()" class="px-4 py-2 bg-white bg-opacity-20 rounded hover:bg-opacity-30">
                                🔄 초기화
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 지역 선택 -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">🗺️ 지역 선택</h3>
                    <div class="space-y-2">
                        <select id="regionSelector" onchange="selectRegion(this.value)" 
                                class="w-full px-3 py-2 text-gray-800 rounded">
                            <option value="">전국 보기</option>
                            <option value="서울특별시">서울특별시</option>
                            <option value="부산광역시">부산광역시</option>
                            <option value="대구광역시">대구광역시</option>
                            <option value="인천광역시">인천광역시</option>
                            <option value="광주광역시">광주광역시</option>
                            <option value="대전광역시">대전광역시</option>
                            <option value="울산광역시">울산광역시</option>
                            <option value="세종특별자치시">세종특별자치시</option>
                            <option value="경기도">경기도</option>
                            <option value="강원특별자치도">강원특별자치도</option>
                            <option value="충청북도">충청북도</option>
                            <option value="충청남도">충청남도</option>
                            <option value="전북특별자치도">전북특별자치도</option>
                            <option value="전라남도">전라남도</option>
                            <option value="경상북도">경상북도</option>
                            <option value="경상남도">경상남도</option>
                            <option value="제주특별자치도">제주특별자치도</option>
                        </select>
                        <div class="text-xs opacity-75">지역 선택 시 해당 지역 확대</div>
                    </div>
                </div>

                <!-- 분석 모드 -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">📊 분석 모드</h3>
                    <div class="space-y-2">
                        <select id="analysisMode" onchange="changeAnalysisMode(this.value)"
                                class="w-full px-3 py-2 text-gray-800 rounded">
                            <option value="population">인구 규모</option>
                            <option value="change_rate">인구 증감률</option>
                            <option value="density">인구 밀도</option>
                            <option value="aging">고령화율</option>
                            <option value="youth">청년 비율</option>
                        </select>
                        <div class="text-xs opacity-75">분석 기준 변경</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 대시보드 -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalDong">3,497</div>
                <div class="text-sm text-gray-600">총 행정동</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="growingDong">0</div>
                <div class="text-sm text-gray-600">인구 증가</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="decliningDong">0</div>
                <div class="text-sm text-gray-600">인구 감소</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="stableDong">0</div>
                <div class="text-sm text-gray-600">안정적</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="selectedDong">0</div>
                <div class="text-sm text-gray-600">선택됨</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-indigo-600" id="avgChangeRate">0.0%</div>
                <div class="text-sm text-gray-600">평균 증감률</div>
            </div>
        </div>

        <!-- 메인 지도 -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">행정동별 인구변화 지도</h2>
                        <div class="flex space-x-2">
                            <button onclick="zoomIn()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">🔍+</button>
                            <button onclick="zoomOut()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">🔍-</button>
                            <button onclick="resetZoom()" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700">🔄</button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <svg id="dongMapSvg" viewBox="0 0 1200 800" class="w-full h-auto border border-gray-200 rounded-lg bg-gray-50">
                            <!-- 범례 -->
                            <g id="populationLegend" class="population-legend" transform="translate(20, 20)">
                                <rect x="0" y="0" width="200" height="200" fill="white" stroke="#ccc" stroke-width="1" rx="8" opacity="0.95"/>
                                <text x="100" y="20" text-anchor="middle" class="text-sm font-bold fill-gray-800">인구 변화율 (%)</text>
                                
                                <circle cx="20" cy="45" r="8" fill="#059669"/>
                                <text x="35" y="50" class="text-xs fill-gray-700">+5% 이상 (급성장)</text>
                                
                                <circle cx="20" cy="70" r="8" fill="#10B981"/>
                                <text x="35" y="75" class="text-xs fill-gray-700">+2~5% (성장)</text>
                                
                                <circle cx="20" cy="95" r="8" fill="#6EE7B7"/>
                                <text x="35" y="100" class="text-xs fill-gray-700">0~2% (미성장)</text>
                                
                                <circle cx="20" cy="120" r="8" fill="#FEF3C7"/>
                                <text x="35" y="125" class="text-xs fill-gray-700">0~-2% (미감소)</text>
                                
                                <circle cx="20" cy="145" r="8" fill="#F59E0B"/>
                                <text x="35" y="150" class="text-xs fill-gray-700">-2~-5% (감소)</text>
                                
                                <circle cx="20" cy="170" r="8" fill="#DC2626"/>
                                <text x="35" y="175" class="text-xs fill-gray-700">-5% 이하 (급감소)</text>
                                
                                <text x="100" y="195" text-anchor="middle" class="text-xs fill-gray-600">클릭: 상세 분석</text>
                            </g>

                            <!-- 행정동 포인트들 (동적 생성) -->
                            <g id="dongPoints"></g>
                            
                            <!-- 지역 경계선 (선택적) -->
                            <g id="regionBoundaries"></g>
                        </svg>
                        
                        <div id="tooltip" class="tooltip hidden"></div>
                    </div>
                </div>
            </div>

            <!-- 분석 패널 -->
            <div class="lg:col-span-1">
                <div class="space-y-6">
                    <!-- 선택된 동 상세 정보 -->
                    <div id="dongDetailPanel" class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">📍 선택된 지역</h3>
                        <div id="dongDetailContent" class="text-sm text-gray-500">
                            행정동을 선택하면 상세 정보가 표시됩니다.
                        </div>
                    </div>

                    <!-- 인구 변화 차트 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">📈 인구 변화 추이</h3>
                        <div id="populationChart" class="h-48 bg-gray-50 rounded flex items-center justify-center">
                            <span class="text-gray-500">지역 선택 시 차트 표시</span>
                        </div>
                    </div>

                    <!-- 지역 통계 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">📊 지역 통계</h3>
                        <div id="regionalStats" class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">평균 인구:</span>
                                <span class="font-medium" id="avgPopulation">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">최대 인구:</span>
                                <span class="font-medium" id="maxPopulation">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">최소 인구:</span>
                                <span class="font-medium" id="minPopulation">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">증감률:</span>
                                <span class="font-medium" id="changeRate">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 핫스팟 정보 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">🔥 인구변화 핫스팟</h3>
                        <div class="space-y-3">
                            <div class="bg-green-50 p-3 rounded">
                                <div class="font-medium text-green-800">급성장 지역</div>
                                <div class="text-sm text-green-600" id="growthHotspot">화성시 동탄신도시 (+15.2%)</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded">
                                <div class="font-medium text-red-800">급감소 지역</div>
                                <div class="text-sm text-red-600" id="declineHotspot">고흥군 농촌지역 (-8.3%)</div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="font-medium text-blue-800">주목 지역</div>
                                <div class="text-sm text-blue-600" id="watchArea">세종시 신도시 (+12.1%)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 상세 분석 모달 -->
        <div id="dongDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto shadow-2xl">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 relative">
                    <button onclick="closeDongModal()" class="absolute top-4 right-4 text-white hover:text-gray-200 text-2xl font-bold">×</button>
                    <div id="modalHeader">
                        <h2 class="text-2xl font-bold" id="modalTitle">행정동 상세 분석</h2>
                        <p class="text-blue-100" id="modalSubtitle">2014-2025년 인구변화 분석</p>
                    </div>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- 동적으로 생성될 상세 분석 내용 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전국 행정동 시뮬레이션 데이터
        let dongData = {};
        let currentYear = 2024;
        let selectedRegion = '';
        let analysisMode = 'population';
        let isAnimating = false;
        let zoomLevel = 1;

        // 시뮬레이션 데이터 생성
        function generateDongData() {
            console.log('🏘️ 행정동 데이터 생성 시작');
            
            const regions = {
                '서울특별시': {count: 467, baseX: 300, baseY: 150, spread: 80},
                '부산광역시': {count: 201, baseX: 850, baseY: 520, spread: 60},
                '대구광역시': {count: 139, baseX: 750, baseY: 450, spread: 50},
                '인천광역시': {count: 152, baseX: 200, baseY: 200, spread: 60},
                '광주광역시': {count: 95, baseX: 400, baseY: 500, spread: 40},
                '대전광역시': {count: 79, baseX: 500, baseY: 350, spread: 40},
                '울산광역시': {count: 56, baseX: 850, baseY: 480, spread: 35},
                '세종특별자치시': {count: 20, baseX: 450, baseY: 320, spread: 25},
                '경기도': {count: 573, baseX: 350, baseY: 200, spread: 120},
                '강원특별자치도': {count: 179, baseX: 650, baseY: 200, spread: 80},
                '충청북도': {count: 153, baseX: 550, baseY: 300, spread: 60},
                '충청남도': {count: 212, baseX: 400, baseY: 320, spread: 70},
                '전북특별자치도': {count: 179, baseX: 450, baseY: 420, spread: 70},
                '전라남도': {count: 196, baseX: 400, baseY: 550, spread: 80},
                '경상북도': {count: 276, baseX: 700, baseY: 350, spread: 90},
                '경상남도': {count: 279, baseX: 750, baseY: 520, spread: 80},
                '제주특별자치도': {count: 43, baseX: 300, baseY: 720, spread: 40}
            };

            dongData = {};
            let totalGenerated = 0;

            Object.entries(regions).forEach(([regionName, regionInfo]) => {
                dongData[regionName] = [];
                
                for (let i = 0; i < regionInfo.count; i++) {
                    // 랜덤 좌표 생성 (지역 범위 내)
                    const angle = (Math.PI * 2 / regionInfo.count) * i + Math.random() * 0.5;
                    const distance = Math.random() * regionInfo.spread;
                    
                    const x = regionInfo.baseX + Math.cos(angle) * distance;
                    const y = regionInfo.baseY + Math.sin(angle) * distance;
                    
                    // 12년간 인구 변화 시뮬레이션
                    const populationHistory = generatePopulationHistory(regionName, i);
                    
                    const dongInfo = {
                        id: `${regionName}_dong_${i+1:03d}`,
                        name: `${regionName.slice(0,2)}${i+1}동`,
                        region: regionName,
                        coordinates: {x: Math.round(x), y: Math.round(y)},
                        populationHistory: populationHistory,
                        characteristics: getDongCharacteristics(regionName, i)
                    };
                    
                    dongData[regionName].push(dongInfo);
                    totalGenerated++;
                }
            });

            console.log(`✅ 생성 완료: ${totalGenerated}개 행정동`);
            return dongData;
        }

        function generatePopulationHistory(regionName, index) {
            const history = {};
            
            // 지역별 기본 인구 범위
            const baseRanges = {
                '서울특별시': {min: 15000, max: 45000},
                '경기도': {min: 12000, max: 60000},
                '부산광역시': {min: 8000, max: 35000}
            };
            
            const range = baseRanges[regionName] || {min: 8000, max: 30000};
            let currentPop = Math.floor(Math.random() * (range.max - range.min) + range.min);
            
            for (let year = 2014; year <= 2025; year++) {
                // 연도별 변화율 (지역 특성 반영)
                let changeRate;
                
                if (regionName === '경기도' && Math.random() > 0.7) {
                    changeRate = Math.random() * 8 - 1; // 신도시 개발
                } else if (regionName.includes('광역시') && year > 2020) {
                    changeRate = Math.random() * 2 - 3; // 광역시 감소
                } else {
                    changeRate = Math.random() * 4 - 2; // 일반적 변화
                }
                
                currentPop = Math.max(1000, Math.floor(currentPop * (1 + changeRate / 100)));
                
                history[year] = {
                    population: currentPop,
                    changeRate: Math.round(changeRate * 100) / 100,
                    density: Math.round(currentPop / Math.random() * 10 + 5000),
                    agingRatio: Math.round((Math.random() * 20 + 10) * 100) / 100,
                    youthRatio: Math.round((Math.random() * 25 + 15) * 100) / 100
                };
            }
            
            return history;
        }

        function getDongCharacteristics(regionName, index) {
            const types = ['주거지역', '상업지역', '산업지역', '혼합지역'];
            const levels = ['상', '중상', '중', '중하', '하'];
            
            return {
                type: types[index % types.length],
                economicLevel: levels[index % levels.length],
                keyFeatures: ['교통편리', '교육환경', '상업시설'].filter(() => Math.random() > 0.5)
            };
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 행정동 지도 시스템 초기화');
            dongData = generateDongData();
            initializeDongMap();
            updateMapByYear(2024);
            updateStatistics();
        });

        function initializeDongMap() {
            const svg = d3.select("#dongMapSvg");
            const pointsGroup = svg.select("#dongPoints");
            
            // 모든 행정동 포인트 생성
            Object.entries(dongData).forEach(([regionName, dongList]) => {
                const regionGroup = pointsGroup.append("g")
                    .attr("class", "region-group")
                    .attr("data-region", regionName);
                
                dongList.forEach(dong => {
                    const circle = regionGroup.append("circle")
                        .attr("cx", dong.coordinates.x)
                        .attr("cy", dong.coordinates.y)
                        .attr("r", 3)
                        .attr("class", "dong-point")
                        .attr("data-dong-id", dong.id)
                        .attr("fill", getDongColor(dong, analysisMode))
                        .attr("stroke", "#374151")
                        .attr("stroke-width", 1)
                        .on("click", () => selectDong(dong))
                        .on("mouseenter", (event) => showDongTooltip(event, dong))
                        .on("mouseleave", hideTooltip);
                });
            });
            
            console.log('🗺️ 행정동 포인트 생성 완료');
        }

        function getDongColor(dong, mode) {
            const currentData = dong.populationHistory[currentYear];
            if (!currentData) return '#E5E7EB';
            
            switch(mode) {
                case 'population':
                    const pop = currentData.population;
                    if (pop > 40000) return '#059669';
                    if (pop > 30000) return '#10B981';
                    if (pop > 20000) return '#6EE7B7';
                    if (pop > 10000) return '#FEF3C7';
                    return '#F59E0B';
                    
                case 'change_rate':
                    const rate = currentData.changeRate;
                    if (rate > 5) return '#059669';
                    if (rate > 2) return '#10B981';
                    if (rate > 0) return '#6EE7B7';
                    if (rate > -2) return '#FEF3C7';
                    if (rate > -5) return '#F59E0B';
                    return '#DC2626';
                    
                case 'aging':
                    const aging = currentData.agingRatio;
                    if (aging > 25) return '#7C2D12';
                    if (aging > 20) return '#DC2626';
                    if (aging > 15) return '#F59E0B';
                    if (aging > 10) return '#FEF3C7';
                    return '#6EE7B7';
                    
                default:
                    return '#3B82F6';
            }
        }

        function updateMapByYear(year) {
            currentYear = parseInt(year);
            document.getElementById('currentYear').textContent = year;
            
            // 모든 동 포인트 색상 업데이트
            d3.selectAll(".dong-point")
                .transition()
                .duration(300)
                .attr("fill", function() {
                    const dongId = d3.select(this).attr("data-dong-id");
                    const dong = findDongById(dongId);
                    return dong ? getDongColor(dong, analysisMode) : '#E5E7EB';
                })
                .attr("r", function() {
                    const dongId = d3.select(this).attr("data-dong-id");
                    const dong = findDongById(dongId);
                    if (!dong) return 3;
                    
                    const population = dong.populationHistory[currentYear]?.population || 0;
                    return Math.max(2, Math.min(8, population / 8000)); // 인구에 따른 크기 조절
                });
            
            updateStatistics();
        }

        function selectRegion(regionName) {
            selectedRegion = regionName;
            
            if (regionName) {
                // 선택된 지역 확대
                const regionData = dongData[regionName];
                if (regionData && regionData.length > 0) {
                    // 지역 경계 계산
                    const xCoords = regionData.map(d => d.coordinates.x);
                    const yCoords = regionData.map(d => d.coordinates.y);
                    
                    const minX = Math.min(...xCoords) - 50;
                    const maxX = Math.max(...xCoords) + 50;
                    const minY = Math.min(...yCoords) - 50;
                    const maxY = Math.max(...yCoords) + 50;
                    
                    // SVG 뷰박스 조정
                    const svg = document.getElementById('dongMapSvg');
                    svg.setAttribute('viewBox', `${minX} ${minY} ${maxX - minX} ${maxY - minY}`);
                    
                    // 다른 지역 투명도 조절
                    d3.selectAll(".region-group")
                        .transition()
                        .duration(500)
                        .style("opacity", function() {
                            const region = d3.select(this).attr("data-region");
                            return region === regionName ? 1 : 0.3;
                        });
                    
                    updateRegionalStats(regionName);
                }
            } else {
                // 전국 보기로 복원
                resetZoom();
            }
        }

        function updateRegionalStats(regionName) {
            const regionData = dongData[regionName];
            if (!regionData) return;
            
            const populations = regionData.map(d => d.populationHistory[currentYear]?.population || 0);
            const changeRates = regionData.map(d => d.populationHistory[currentYear]?.changeRate || 0);
            
            const avgPop = Math.round(populations.reduce((a, b) => a + b, 0) / populations.length);
            const maxPop = Math.max(...populations);
            const minPop = Math.min(...populations);
            const avgChange = Math.round((changeRates.reduce((a, b) => a + b, 0) / changeRates.length) * 100) / 100;
            
            document.getElementById('avgPopulation').textContent = avgPop.toLocaleString() + '명';
            document.getElementById('maxPopulation').textContent = maxPop.toLocaleString() + '명';
            document.getElementById('minPopulation').textContent = minPop.toLocaleString() + '명';
            document.getElementById('changeRate').textContent = avgChange + '%';
        }

        function selectDong(dong) {
            const currentData = dong.populationHistory[currentYear];
            
            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="text-sm text-blue-600">현재 인구</div>
                            <div class="text-2xl font-bold text-blue-800">${currentData.population.toLocaleString()}명</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded">
                            <div class="text-sm text-green-600">인구 변화율</div>
                            <div class="text-2xl font-bold ${currentData.changeRate > 0 ? 'text-green-800' : 'text-red-800'}">
                                ${currentData.changeRate > 0 ? '+' : ''}${currentData.changeRate}%
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded">
                            <div class="text-sm text-purple-600">고령화율</div>
                            <div class="text-2xl font-bold text-purple-800">${currentData.agingRatio}%</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded">
                            <div class="text-sm text-orange-600">청년 비율</div>
                            <div class="text-2xl font-bold text-orange-800">${currentData.youthRatio}%</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded">
                        <div class="font-medium mb-2">지역 특성</div>
                        <div class="text-sm space-y-1">
                            <div>🏠 지역 유형: ${dong.characteristics.type}</div>
                            <div>💰 경제 수준: ${dong.characteristics.economicLevel}</div>
                            <div>🏷️ 주요 특징: ${dong.characteristics.keyFeatures.join(', ') || '일반 주거지역'}</div>
                        </div>
                    </div>
                    
                    <button onclick="showDetailedAnalysis('${dong.id}')" 
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        📊 상세 분석 보기
                    </button>
                </div>
            `;
            
            document.getElementById('dongDetailContent').innerHTML = content;
            document.getElementById('selectedDong').textContent = '1';
            
            // 선택된 동 하이라이트
            d3.selectAll(".dong-point").attr("stroke-width", 1);
            d3.select(`[data-dong-id="${dong.id}"]`)
                .attr("stroke-width", 4)
                .attr("stroke", "#EF4444");
        }

        function showDongTooltip(event, dong) {
            const currentData = dong.populationHistory[currentYear];
            
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div><strong>${dong.name}</strong></div>
                <div>${dong.region}</div>
                <div>인구: ${currentData.population.toLocaleString()}명</div>
                <div>변화율: ${currentData.changeRate > 0 ? '+' : ''}${currentData.changeRate}%</div>
                <div>고령화: ${currentData.agingRatio}%</div>
                <div class="text-xs mt-1 opacity-75">클릭하여 상세 정보</div>
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        function updateStatistics() {
            let growing = 0, declining = 0, stable = 0;
            let totalChangeRate = 0, totalDong = 0;
            
            Object.values(dongData).forEach(dongList => {
                dongList.forEach(dong => {
                    const currentData = dong.populationHistory[currentYear];
                    if (currentData) {
                        totalDong++;
                        totalChangeRate += currentData.changeRate;
                        
                        if (currentData.changeRate > 1) growing++;
                        else if (currentData.changeRate < -1) declining++;
                        else stable++;
                    }
                });
            });
            
            document.getElementById('growingDong').textContent = growing;
            document.getElementById('decliningDong').textContent = declining;
            document.getElementById('stableDong').textContent = stable;
            document.getElementById('avgChangeRate').textContent = 
                totalDong > 0 ? (Math.round((totalChangeRate / totalDong) * 100) / 100) + '%' : '0.0%';
        }

        function changeAnalysisMode(mode) {
            analysisMode = mode;
            updateMapByYear(currentYear);
        }

        function playAnimation() {
            if (isAnimating) return;
            
            isAnimating = true;
            document.getElementById('playBtn').textContent = '⏸️ 정지';
            
            let year = 2014;
            const interval = setInterval(() => {
                if (!isAnimating || year > 2025) {
                    clearInterval(interval);
                    isAnimating = false;
                    document.getElementById('playBtn').textContent = '▶️ 재생';
                    return;
                }
                
                document.getElementById('yearSlider').value = year;
                updateMapByYear(year);
                year++;
            }, 800);
        }

        function resetMap() {
            selectedRegion = '';
            document.getElementById('regionSelector').value = '';
            resetZoom();
            d3.selectAll(".region-group").style("opacity", 1);
            d3.selectAll(".dong-point").attr("stroke-width", 1);
            document.getElementById('selectedDong').textContent = '0';
        }

        function resetZoom() {
            document.getElementById('dongMapSvg').setAttribute('viewBox', '0 0 1200 800');
            zoomLevel = 1;
        }

        function zoomIn() {
            zoomLevel *= 1.2;
            // 줌 구현 (중심점 기준)
        }

        function zoomOut() {
            zoomLevel /= 1.2;
            // 줌 아웃 구현
        }

        function findDongById(dongId) {
            for (const dongList of Object.values(dongData)) {
                const found = dongList.find(d => d.id === dongId);
                if (found) return found;
            }
            return null;
        }

        function showDetailedAnalysis(dongId) {
            const dong = findDongById(dongId);
            if (!dong) return;
            
            document.getElementById('modalTitle').textContent = dong.name + ' 상세 분석';
            document.getElementById('modalSubtitle').textContent = `${dong.region} 소속 행정동`;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">📊 12년간 인구 변화</h3>
                            <div class="space-y-2 text-sm">
                                ${Object.entries(dong.populationHistory).map(([year, data]) => `
                                    <div class="flex justify-between items-center p-2 ${year == currentYear ? 'bg-blue-50 font-bold' : 'hover:bg-gray-50'} rounded">
                                        <span>${year}년</span>
                                        <span>${data.population.toLocaleString()}명</span>
                                        <span class="${data.changeRate > 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${data.changeRate > 0 ? '+' : ''}${data.changeRate}%
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3">🎯 선거 영향 분석</h3>
                            <div class="space-y-3">
                                <div class="bg-blue-50 p-4 rounded">
                                    <div class="font-medium">인구 트렌드</div>
                                    <div class="text-sm text-blue-600">
                                        ${dong.populationHistory[currentYear].changeRate > 0 ? '증가 추세' : '감소 추세'}
                                    </div>
                                </div>
                                <div class="bg-green-50 p-4 rounded">
                                    <div class="font-medium">선거 영향도</div>
                                    <div class="text-sm text-green-600">
                                        ${Math.abs(dong.populationHistory[currentYear].changeRate) > 3 ? '높음' : '보통'}
                                    </div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded">
                                    <div class="font-medium">예측 신뢰도</div>
                                    <div class="text-sm text-purple-600">85%+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('dongDetailModal').classList.remove('hidden');
        }

        function closeDongModal() {
            document.getElementById('dongDetailModal').classList.add('hidden');
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('dongDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDongModal();
            }
        });

        console.log('🏘️ 전국 행정동별 인구변화 지도 시스템 로드 완료');
    </script>
</body>
</html>
