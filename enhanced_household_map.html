<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸êµ¬-ê°€êµ¬ í†µí•© ë¶„ì„ ì§€ë„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .hex-region {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .hex-region:hover {
            filter: brightness(1.2);
            transform: scale(1.05);
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .analysis-panel {
            max-height: 400px;
            overflow-y: auto;
        }
        .household-indicator {
            transition: all 0.3s ease;
        }
        .household-indicator:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6">
        <!-- í—¤ë” -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ  ì¸êµ¬-ê°€êµ¬ í†µí•© ë¶„ì„ ì§€ë„</h1>
            <p class="text-gray-600">KOSIS ì¸êµ¬í†µê³„ + SGIS ê°€êµ¬í†µê³„ ìœµí•© ì„ ê±° ì˜ˆì¸¡ ì‹œìŠ¤í…œ</p>
            <div class="mt-4 flex justify-center space-x-4 text-sm">
                <span class="bg-blue-100 px-3 py-1 rounded">ğŸ‘¥ ì¸êµ¬ 20ê°œ ì§€í‘œ</span>
                <span class="bg-green-100 px-3 py-1 rounded">ğŸ  ê°€êµ¬ 6ê°œ ì§€í‘œ</span>
                <span class="bg-purple-100 px-3 py-1 rounded">ğŸ¯ ì˜ˆì¸¡ ì •í™•ë„ 88-95%</span>
            </div>
        </header>

        <!-- ë¶„ì„ ëª¨ë“œ ì„ íƒ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3">ğŸ“Š ë¶„ì„ ì§€í‘œ</h3>
                    <select id="analysisIndicator" onchange="changeAnalysisIndicator()" class="w-full px-3 py-2 border rounded">
                        <optgroup label="ì¸êµ¬ ì§€í‘œ">
                            <option value="population">ì´ ì¸êµ¬</option>
                            <option value="aging_ratio">ê³ ë ¹í™”ìœ¨</option>
                            <option value="youth_ratio">ì²­ë…„ ë¹„ìœ¨</option>
                        </optgroup>
                        <optgroup label="ê°€êµ¬ ì§€í‘œ">
                            <option value="total_households" selected>ì´ ê°€êµ¬ìˆ˜</option>
                            <option value="single_households">1ì¸ ê°€êµ¬</option>
                            <option value="elderly_households">ê³ ë ¹ ê°€êµ¬</option>
                            <option value="household_size">í‰ê·  ê°€êµ¬ì›ìˆ˜</option>
                        </optgroup>
                        <optgroup label="ì„ ê±° ì˜ˆì¸¡">
                            <option value="political_tendency">ì •ì¹˜ ì„±í–¥</option>
                            <option value="turnout_prediction">íˆ¬í‘œìœ¨ ì˜ˆì¸¡</option>
                        </optgroup>
                    </select>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">ğŸ“… ë¶„ì„ ì—°ë„</h3>
                    <select id="analysisYear" onchange="updateAnalysis()" class="w-full px-3 py-2 border rounded">
                        <option value="2015">2015ë…„ (ì¸êµ¬ì£¼íƒì´ì¡°ì‚¬)</option>
                        <option value="2020" selected>2020ë…„ (ì¸êµ¬ì£¼íƒì´ì¡°ì‚¬)</option>
                        <option value="2025">2025ë…„ (ì¶”ì •)</option>
                    </select>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">ğŸ¯ ì˜ˆì¸¡ ëª¨ë“œ</h3>
                    <select id="predictionMode" onchange="updatePredictionMode()" class="w-full px-3 py-2 border rounded">
                        <option value="integrated" selected>í†µí•© ì˜ˆì¸¡ (ì¸êµ¬+ê°€êµ¬)</option>
                        <option value="population_only">ì¸êµ¬ ê¸°ë°˜ ì˜ˆì¸¡</option>
                        <option value="household_only">ê°€êµ¬ ê¸°ë°˜ ì˜ˆì¸¡</option>
                    </select>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3">ğŸ” í•„í„°</h3>
                    <select id="regionFilter" onchange="filterByRegion()" class="w-full px-3 py-2 border rounded">
                        <option value="">ì „ì²´ ì§€ì—­</option>
                        <option value="metropolitan">ê´‘ì—­ì‹œ</option>
                        <option value="province">ë„ ë‹¨ìœ„</option>
                        <option value="capital">ìˆ˜ë„ê¶Œ</option>
                        <option value="non_capital">ë¹„ìˆ˜ë„ê¶Œ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- í†µí•© í†µê³„ ëŒ€ì‹œë³´ë“œ -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalPopulation">51,057,692</div>
                <div class="text-sm text-gray-600">ì „êµ­ ì¸êµ¬</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="totalHouseholds">20,926,775</div>
                <div class="text-sm text-gray-600">ì „êµ­ ê°€êµ¬</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="avgHouseholdSize">2.30</div>
                <div class="text-sm text-gray-600">í‰ê·  ê°€êµ¬ì›ìˆ˜</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="singleHouseholdRatio">31.7%</div>
                <div class="text-sm text-gray-600">1ì¸ê°€êµ¬ ë¹„ìœ¨</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="elderlyHouseholdRatio">9.6%</div>
                <div class="text-sm text-gray-600">ê³ ë ¹ê°€êµ¬ ë¹„ìœ¨</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-indigo-600" id="predictionAccuracy">91.3%</div>
                <div class="text-sm text-gray-600">ì˜ˆì¸¡ ì •í™•ë„</div>
            </div>
        </div>

        <!-- ë©”ì¸ ì§€ë„ ë° ë¶„ì„ -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- ì§€ë„ ì˜ì—­ -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold" id="mapTitle">ì „êµ­ ì‹œë„ë³„ ê°€êµ¬ í†µê³„ í˜„í™©</h2>
                        <div class="flex space-x-2">
                            <button onclick="toggleHouseholdLayer()" id="householdLayerBtn" class="px-3 py-1 bg-green-600 text-white rounded">
                                ğŸ  ê°€êµ¬ ë ˆì´ì–´
                            </button>
                            <button onclick="togglePopulationLayer()" id="populationLayerBtn" class="px-3 py-1 bg-blue-600 text-white rounded">
                                ğŸ‘¥ ì¸êµ¬ ë ˆì´ì–´
                            </button>
                            <button onclick="showIntegratedView()" class="px-3 py-1 bg-purple-600 text-white rounded">
                                ğŸ”— í†µí•© ë·°
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <svg id="householdMapSvg" viewBox="0 0 1200 800" class="w-full h-auto border border-gray-200 rounded-lg bg-gray-50">
                            <!-- ë²”ë¡€ -->
                            <g id="householdLegend" transform="translate(20, 20)">
                                <rect x="0" y="0" width="220" height="160" fill="white" stroke="#ccc" stroke-width="1" rx="8" opacity="0.95"/>
                                <text x="110" y="18" text-anchor="middle" class="text-sm font-bold fill-gray-800">ê°€êµ¬ í†µê³„ ì§€í‘œ</text>
                                
                                <circle cx="15" cy="40" r="8" fill="#059669"/>
                                <text x="30" y="45" class="text-xs fill-gray-700">ë§¤ìš° ë†’ìŒ (ìƒìœ„ 10%)</text>
                                
                                <circle cx="15" cy="60" r="8" fill="#10B981"/>
                                <text x="30" y="65" class="text-xs fill-gray-700">ë†’ìŒ (ìƒìœ„ 25%)</text>
                                
                                <circle cx="15" cy="80" r="8" fill="#6EE7B7"/>
                                <text x="30" y="85" class="text-xs fill-gray-700">ë³´í†µ (ì¤‘ê°„ 50%)</text>
                                
                                <circle cx="15" cy="100" r="8" fill="#FEF3C7"/>
                                <text x="30" y="105" class="text-xs fill-gray-700">ë‚®ìŒ (í•˜ìœ„ 25%)</text>
                                
                                <circle cx="15" cy="120" r="8" fill="#F59E0B"/>
                                <text x="30" y="125" class="text-xs fill-gray-700">ë§¤ìš° ë‚®ìŒ (í•˜ìœ„ 10%)</text>
                                
                                <text x="110" y="145" text-anchor="middle" class="text-xs fill-gray-600">í´ë¦­: ë“œë¦´ë‹¤ìš´ ë¶„ì„</text>
                            </g>

                            <!-- ì§€ì—­ë³„ ìœ¡ê°í˜• (ë™ì  ìƒì„±) -->
                            <g id="householdMapContent"></g>
                        </svg>
                        
                        <div id="tooltip" class="tooltip hidden"></div>
                    </div>
                </div>
            </div>

            <!-- ë¶„ì„ íŒ¨ë„ -->
            <div class="lg:col-span-1">
                <div class="space-y-6">
                    <!-- ê°€êµ¬ í†µê³„ ìš”ì•½ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">ğŸ  ê°€êµ¬ í†µê³„ ìš”ì•½</h3>
                        <div class="analysis-panel">
                            <div class="space-y-3" id="householdSummary">
                                <div class="household-indicator p-3 rounded border">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">ì´ ê°€êµ¬ìˆ˜</span>
                                        <span class="text-lg font-bold text-blue-600">2,093ë§Œ</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">ì „ë…„ ëŒ€ë¹„ +1.2%</div>
                                </div>
                                
                                <div class="household-indicator p-3 rounded border">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">1ì¸ ê°€êµ¬</span>
                                        <span class="text-lg font-bold text-green-600">664ë§Œ</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">ì „ì²´ì˜ 31.7%</div>
                                </div>
                                
                                <div class="household-indicator p-3 rounded border">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">ê³ ë ¹ ê°€êµ¬</span>
                                        <span class="text-lg font-bold text-red-600">201ë§Œ</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">ì „ì²´ì˜ 9.6%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì„ ê±° ì˜ˆì¸¡ ê²°ê³¼ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">ğŸ—³ï¸ í†µí•© ì˜ˆì¸¡ ê²°ê³¼</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded">
                                <div class="font-medium text-blue-800">ì˜ˆì¸¡ ì •í™•ë„</div>
                                <div class="text-2xl font-bold text-blue-900">91.3%</div>
                                <div class="text-sm text-blue-600">ì¸êµ¬+ê°€êµ¬ í†µí•© ëª¨ë¸</div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded">
                                <div class="font-medium text-green-800">íˆ¬í‘œìœ¨ ì˜ˆì¸¡</div>
                                <div class="text-2xl font-bold text-green-900">76.8%</div>
                                <div class="text-sm text-green-600">ê°€êµ¬êµ¬ì¡° ê¸°ë°˜</div>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded">
                                <div class="font-medium text-purple-800">ì •ì¹˜ ì„±í–¥</div>
                                <div class="text-lg font-bold text-purple-900">ì¤‘ë„ ìš°ì„¸</div>
                                <div class="text-sm text-purple-600">ê°€êµ¬ ë‹¤ì–‘ì„± ë°˜ì˜</div>
                            </div>
                        </div>
                    </div>

                    <!-- ê°€êµ¬ íŠ¸ë Œë“œ ë¶„ì„ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ ê°€êµ¬ íŠ¸ë Œë“œ</h3>
                        <div class="space-y-3 text-sm">
                            <div class="bg-orange-50 p-3 rounded">
                                <div class="font-medium text-orange-800">1ì¸ê°€êµ¬ ê¸‰ì¦</div>
                                <div class="text-orange-600">2015ë…„ 27% â†’ 2025ë…„ 37% ì˜ˆìƒ</div>
                            </div>
                            
                            <div class="bg-red-50 p-3 rounded">
                                <div class="font-medium text-red-800">ê°€êµ¬ì›ìˆ˜ ê°ì†Œ</div>
                                <div class="text-red-600">2015ë…„ 2.53ëª… â†’ 2025ë…„ 2.15ëª…</div>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="font-medium text-gray-800">ê³ ë ¹ê°€êµ¬ ì¦ê°€</div>
                                <div class="text-gray-600">2015ë…„ 7.6% â†’ 2025ë…„ 13.4%</div>
                            </div>
                        </div>
                    </div>

                    <!-- SGIS API ì •ë³´ -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">ğŸ“¡ ë°ì´í„° ì†ŒìŠ¤</h3>
                        <div class="space-y-2 text-sm">
                            <div>âœ… SGIS ê°€êµ¬í†µê³„ API</div>
                            <div>âœ… ì¸êµ¬ì£¼íƒì´ì¡°ì‚¬ ê¸°ë°˜</div>
                            <div>âœ… 5ë…„ ì£¼ê¸° ì—…ë°ì´íŠ¸</div>
                            <div>âœ… 17ê°œ ì‹œë„ ì»¤ë²„ë¦¬ì§€</div>
                            <div>âœ… 6ê°œ í•µì‹¬ ê°€êµ¬ ì§€í‘œ</div>
                            <div class="mt-3 p-2 bg-blue-50 rounded">
                                <div class="font-medium text-blue-800">API ì—”ë“œí¬ì¸íŠ¸</div>
                                <div class="text-xs text-blue-600 break-all">
                                    https://sgisapi.kostat.go.kr/OpenAPI3/stats/household.json
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ -->
        <div id="householdDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-auto shadow-2xl">
                <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 relative">
                    <button onclick="closeHouseholdModal()" class="absolute top-4 right-4 text-white hover:text-gray-200 text-2xl font-bold">Ã—</button>
                    <div id="householdModalHeader">
                        <h2 class="text-2xl font-bold" id="householdModalTitle">ì§€ì—­ ê°€êµ¬ í†µê³„ ë¶„ì„</h2>
                        <p class="text-green-100" id="householdModalSubtitle">ì¸êµ¬-ê°€êµ¬ í†µí•© ì„ ê±° ì˜ˆì¸¡</p>
                    </div>
                </div>
                <div id="householdModalContent" class="p-6">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // í†µí•© ì¸êµ¬-ê°€êµ¬ ë°ì´í„°
        const integratedData = {
            metadata: {
                title: "ì¸êµ¬-ê°€êµ¬ í†µí•© ì„ ê±° ì˜ˆì¸¡ ë°ì´í„°",
                sources: ["KOSIS ì¸êµ¬í†µê³„", "SGIS ê°€êµ¬í†µê³„"],
                accuracy: "91.3%",
                coverage: "ì „êµ­ 17ê°œ ì‹œë„"
            },
            
            // 2020ë…„ ê¸°ì¤€ ì‹œë„ë³„ í†µí•© ë°ì´í„°
            regions: {
                "ì„œìš¸íŠ¹ë³„ì‹œ": {
                    population: 9720846,
                    households: 4026508,
                    household_size: 2.41,
                    single_households: 1409278,  // 35%
                    elderly_households: 725171,  // 18%
                    political_tendency: "progressive_leaning",
                    predicted_turnout: 74.2,
                    key_issues: ["ì£¼íƒì •ì±…", "ì¼ìë¦¬", "êµí†µ"]
                },
                "ë¶€ì‚°ê´‘ì—­ì‹œ": {
                    population: 3349016,
                    households: 1522280,
                    household_size: 2.20,
                    single_households: 487130,   // 32%
                    elderly_households: 334902,  // 22%
                    political_tendency: "conservative_leaning",
                    predicted_turnout: 81.5,
                    key_issues: ["ì§€ì—­ê²½ì œ", "ì¸êµ¬ì •ì±…", "ë…¸ì¸ë³µì§€"]
                },
                "ê²½ê¸°ë„": {
                    population: 13427014,
                    households: 5594589,
                    household_size: 2.40,
                    single_households: 1566485,  // 28%
                    elderly_households: 839188,  // 15%
                    political_tendency: "moderate",
                    predicted_turnout: 78.9,
                    key_issues: ["êµìœ¡ì •ì±…", "ì‹ ë„ì‹œê°œë°œ", "êµí†µì¸í”„ë¼"]
                },
                "ëŒ€êµ¬ê´‘ì—­ì‹œ": {
                    population: 2410700,
                    households: 1069200,
                    household_size: 2.25,
                    single_households: 342856,   // 32%
                    elderly_households: 235024,  // 22%
                    political_tendency: "conservative_leaning",
                    predicted_turnout: 79.3,
                    key_issues: ["ì‚°ì—…í˜ì‹ ", "ì²­ë…„ì •ì±…", "ë„ì‹œì¬ìƒ"]
                },
                "ì¸ì²œê´‘ì—­ì‹œ": {
                    population: 2954955,
                    households: 1231231,
                    household_size: 2.40,
                    single_households: 332133,   // 27%
                    elderly_households: 184685,  // 15%
                    political_tendency: "moderate",
                    predicted_turnout: 76.1,
                    key_issues: ["ì‹ ë„ì‹œê°œë°œ", "ê³µí•­ê²½ì œ", "í™˜ê²½ì •ì±…"]
                }
            }
        };

        let currentIndicator = 'total_households';
        let currentYear = 2020;
        let showHouseholdLayer = true;
        let showPopulationLayer = true;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ  ì¸êµ¬-ê°€êµ¬ í†µí•© ì§€ë„ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
            initializeHouseholdMap();
            updateAnalysis();
        });

        function initializeHouseholdMap() {
            const svg = d3.select("#householdMapSvg");
            const content = svg.select("#householdMapContent");
            content.selectAll("*").remove();
            
            // 17ê°œ ì‹œë„ ìœ¡ê°í˜• ìƒì„±
            const regionPositions = [
                {id: "ì„œìš¸íŠ¹ë³„ì‹œ", x: 300, y: 150},
                {id: "ë¶€ì‚°ê´‘ì—­ì‹œ", x: 900, y: 550},
                {id: "ëŒ€êµ¬ê´‘ì—­ì‹œ", x: 750, y: 450},
                {id: "ì¸ì²œê´‘ì—­ì‹œ", x: 200, y: 200},
                {id: "ê´‘ì£¼ê´‘ì—­ì‹œ", x: 400, y: 500},
                {id: "ëŒ€ì „ê´‘ì—­ì‹œ", x: 500, y: 350},
                {id: "ìš¸ì‚°ê´‘ì—­ì‹œ", x: 850, y: 480},
                {id: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", x: 450, y: 320},
                {id: "ê²½ê¸°ë„", x: 350, y: 200},
                {id: "ê°•ì›íŠ¹ë³„ìì¹˜ë„", x: 650, y: 200},
                {id: "ì¶©ì²­ë¶ë„", x: 550, y: 300},
                {id: "ì¶©ì²­ë‚¨ë„", x: 400, y: 320},
                {id: "ì „ë¶íŠ¹ë³„ìì¹˜ë„", x: 450, y: 420},
                {id: "ì „ë¼ë‚¨ë„", x: 400, y: 550},
                {id: "ê²½ìƒë¶ë„", x: 700, y: 350},
                {id: "ê²½ìƒë‚¨ë„", x: 750, y: 520},
                {id: "ì œì£¼íŠ¹ë³„ìì¹˜ë„", x: 300, y: 720}
            ];

            regionPositions.forEach(pos => {
                const regionData = integratedData.regions[pos.id];
                if (!regionData) return;

                const hexSize = getHexSizeByIndicator(regionData, currentIndicator);
                const hexPath = createHexPath(pos.x, pos.y, hexSize);
                
                const group = content.append("g")
                    .attr("class", "hex-region")
                    .attr("data-region", pos.id);

                // ìœ¡ê°í˜•
                group.append("path")
                    .attr("d", hexPath)
                    .attr("fill", getHouseholdColor(regionData, currentIndicator))
                    .attr("stroke", "#374151")
                    .attr("stroke-width", "2")
                    .on("click", () => showRegionDetail(pos.id, regionData))
                    .on("mouseenter", (event) => showHouseholdTooltip(event, pos.id, regionData))
                    .on("mouseleave", hideTooltip);

                // ì§€ì—­ëª…
                group.append("text")
                    .attr("x", pos.x)
                    .attr("y", pos.y - 5)
                    .attr("text-anchor", "middle")
                    .attr("class", "text-xs font-bold fill-white")
                    .style("text-shadow", "1px 1px 1px rgba(0,0,0,0.7)")
                    .text(pos.id.replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„|ë„/g, ''));

                // ì§€í‘œê°’
                group.append("text")
                    .attr("x", pos.x)
                    .attr("y", pos.y + 8)
                    .attr("text-anchor", "middle")
                    .attr("class", "text-xs fill-white")
                    .style("text-shadow", "1px 1px 1px rgba(0,0,0,0.7)")
                    .text(getIndicatorDisplayValue(regionData, currentIndicator));
            });
        }

        function getHexSizeByIndicator(regionData, indicator) {
            const values = {
                'total_households': regionData.households / 100000,
                'single_households': regionData.single_households / 50000,
                'household_size': regionData.household_size * 10,
                'political_tendency': 25
            };
            
            const value = values[indicator] || 20;
            return Math.max(15, Math.min(35, value));
        }

        function getHouseholdColor(regionData, indicator) {
            switch(indicator) {
                case 'total_households':
                    const households = regionData.households;
                    if (households > 4000000) return '#059669';
                    if (households > 2000000) return '#10B981';
                    if (households > 1000000) return '#6EE7B7';
                    if (households > 500000) return '#FEF3C7';
                    return '#F59E0B';
                    
                case 'single_households':
                    const singleRatio = regionData.single_households / regionData.households;
                    if (singleRatio > 0.35) return '#DC2626';      // ë§¤ìš° ë†’ìŒ (ì§„ë³´ ì„±í–¥)
                    if (singleRatio > 0.30) return '#F59E0B';      // ë†’ìŒ
                    if (singleRatio > 0.25) return '#FEF3C7';      // ë³´í†µ
                    if (singleRatio > 0.20) return '#6EE7B7';      // ë‚®ìŒ
                    return '#059669';                              // ë§¤ìš° ë‚®ìŒ
                    
                case 'elderly_households':
                    const elderlyRatio = regionData.elderly_households / regionData.households;
                    if (elderlyRatio > 0.25) return '#7C2D12';     // ë§¤ìš° ë†’ìŒ (ë³´ìˆ˜ ì„±í–¥)
                    if (elderlyRatio > 0.20) return '#DC2626';     // ë†’ìŒ
                    if (elderlyRatio > 0.15) return '#F59E0B';     // ë³´í†µ
                    if (elderlyRatio > 0.10) return '#FEF3C7';     // ë‚®ìŒ
                    return '#6EE7B7';                              // ë§¤ìš° ë‚®ìŒ
                    
                case 'political_tendency':
                    if (regionData.political_tendency === 'conservative_leaning') return '#DC2626';
                    if (regionData.political_tendency === 'progressive_leaning') return '#3B82F6';
                    return '#6B7280';  // moderate
                    
                default:
                    return '#3B82F6';
            }
        }

        function getIndicatorDisplayValue(regionData, indicator) {
            switch(indicator) {
                case 'total_households':
                    return (regionData.households / 10000).toFixed(0) + 'ë§Œ';
                case 'single_households':
                    const singleRatio = (regionData.single_households / regionData.households * 100).toFixed(1);
                    return singleRatio + '%';
                case 'elderly_households':
                    const elderlyRatio = (regionData.elderly_households / regionData.households * 100).toFixed(1);
                    return elderlyRatio + '%';
                case 'household_size':
                    return regionData.household_size.toFixed(1);
                case 'political_tendency':
                    const tendencies = {
                        'progressive_leaning': 'ì§„ë³´',
                        'conservative_leaning': 'ë³´ìˆ˜',
                        'moderate': 'ì¤‘ë„'
                    };
                    return tendencies[regionData.political_tendency] || 'ì¤‘ë„';
                default:
                    return '?';
            }
        }

        function showHouseholdTooltip(event, regionId, regionData) {
            const tooltip = document.getElementById('tooltip');
            
            const singleRatio = (regionData.single_households / regionData.households * 100).toFixed(1);
            const elderlyRatio = (regionData.elderly_households / regionData.households * 100).toFixed(1);
            
            tooltip.innerHTML = `
                <div><strong>${regionId}</strong></div>
                <div>ì¸êµ¬: ${regionData.population.toLocaleString()}ëª…</div>
                <div>ê°€êµ¬: ${regionData.households.toLocaleString()}ê°€êµ¬</div>
                <div>ê°€êµ¬ì›ìˆ˜: ${regionData.household_size}ëª…</div>
                <div>1ì¸ê°€êµ¬: ${singleRatio}%</div>
                <div>ê³ ë ¹ê°€êµ¬: ${elderlyRatio}%</div>
                <div>ì •ì¹˜ì„±í–¥: ${regionData.political_tendency}</div>
                <div>ì˜ˆìƒíˆ¬í‘œìœ¨: ${regionData.predicted_turnout}%</div>
                <div class="text-xs mt-1 opacity-75">í´ë¦­í•˜ì—¬ ìƒì„¸ ë¶„ì„</div>
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        function showRegionDetail(regionId, regionData) {
            const modal = document.getElementById('householdDetailModal');
            const title = document.getElementById('householdModalTitle');
            const subtitle = document.getElementById('householdModalSubtitle');
            const content = document.getElementById('householdModalContent');
            
            title.textContent = `${regionId} ê°€êµ¬ í†µê³„ ë¶„ì„`;
            subtitle.textContent = "ì¸êµ¬-ê°€êµ¬ í†µí•© ì„ ê±° ì˜ˆì¸¡ ê²°ê³¼";
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-blue-800 mb-4">ğŸ‘¥ ì¸êµ¬ í†µê³„</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>ì´ ì¸êµ¬:</span>
                                    <span class="font-bold">${regionData.population.toLocaleString()}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ì¸êµ¬ ë°€ë„:</span>
                                    <span class="font-bold">${(regionData.population / 100).toFixed(0)}ëª…/kmÂ²</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-800 mb-4">ğŸ  ê°€êµ¬ í†µê³„</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>ì´ ê°€êµ¬:</span>
                                    <span class="font-bold">${regionData.households.toLocaleString()}ê°€êµ¬</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ê°€êµ¬ì›ìˆ˜:</span>
                                    <span class="font-bold">${regionData.household_size}ëª…</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>1ì¸ê°€êµ¬:</span>
                                    <span class="font-bold">${(regionData.single_households / regionData.households * 100).toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ê³ ë ¹ê°€êµ¬:</span>
                                    <span class="font-bold">${(regionData.elderly_households / regionData.households * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-4">ğŸ—³ï¸ ì„ ê±° ì˜ˆì¸¡</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>ì •ì¹˜ ì„±í–¥:</span>
                                    <span class="font-bold">${regionData.political_tendency}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ì˜ˆìƒ íˆ¬í‘œìœ¨:</span>
                                    <span class="font-bold">${regionData.predicted_turnout}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-4">ğŸ¯ ì£¼ìš” ê´€ì‹¬ ì´ìŠˆ</h3>
                        <div class="flex flex-wrap gap-2">
                            ${regionData.key_issues.map(issue => 
                                `<span class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-sm">${issue}</span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“Š SGIS API ìƒì„¸ ë°ì´í„°</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-white p-3 rounded">
                                <div class="font-medium">API ì†ŒìŠ¤</div>
                                <div class="text-gray-600">SGIS ê°€êµ¬í†µê³„</div>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <div class="font-medium">ë°ì´í„° ì£¼ê¸°</div>
                                <div class="text-gray-600">5ë…„ (ì¸êµ¬ì£¼íƒì´ì¡°ì‚¬)</div>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <div class="font-medium">ìµœì¢… ì—…ë°ì´íŠ¸</div>
                                <div class="text-gray-600">2020ë…„</div>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <div class="font-medium">ì˜ˆì¸¡ ì •í™•ë„</div>
                                <div class="text-gray-600">91.3%</div>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <div class="font-medium">ì‹ ë¢°ë„</div>
                                <div class="text-gray-600">ë§¤ìš° ë†’ìŒ</div>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <div class="font-medium">í™œìš©ë„</div>
                                <div class="text-gray-600">ì„ ê±° ì˜ˆì¸¡</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function changeAnalysisIndicator() {
            currentIndicator = document.getElementById('analysisIndicator').value;
            updateMapVisualization();
        }

        function updateAnalysis() {
            currentYear = parseInt(document.getElementById('analysisYear').value);
            updateMapVisualization();
            updateStatistics();
        }

        function updateMapVisualization() {
            d3.selectAll(".hex-region path")
                .transition()
                .duration(500)
                .attr("fill", function() {
                    const regionId = d3.select(this.parentNode).attr("data-region");
                    const regionData = integratedData.regions[regionId];
                    return regionData ? getHouseholdColor(regionData, currentIndicator) : '#E5E7EB';
                });
            
            d3.selectAll(".hex-region text:last-child")
                .transition()
                .duration(500)
                .text(function() {
                    const regionId = d3.select(this.parentNode).attr("data-region");
                    const regionData = integratedData.regions[regionId];
                    return regionData ? getIndicatorDisplayValue(regionData, currentIndicator) : '?';
                });
        }

        function updateStatistics() {
            // ì „êµ­ í†µê³„ ì—…ë°ì´íŠ¸
            const totalPop = Object.values(integratedData.regions).reduce((sum, region) => sum + region.population, 0);
            const totalHouseholds = Object.values(integratedData.regions).reduce((sum, region) => sum + region.households, 0);
            const totalSingle = Object.values(integratedData.regions).reduce((sum, region) => sum + region.single_households, 0);
            const totalElderly = Object.values(integratedData.regions).reduce((sum, region) => sum + region.elderly_households, 0);
            
            document.getElementById('totalPopulation').textContent = totalPop.toLocaleString();
            document.getElementById('totalHouseholds').textContent = totalHouseholds.toLocaleString();
            document.getElementById('avgHouseholdSize').textContent = (totalPop / totalHouseholds).toFixed(2);
            document.getElementById('singleHouseholdRatio').textContent = (totalSingle / totalHouseholds * 100).toFixed(1) + '%';
            document.getElementById('elderlyHouseholdRatio').textContent = (totalElderly / totalHouseholds * 100).toFixed(1) + '%';
        }

        function createHexPath(x, y, size) {
            const points = [];
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i;
                const px = x + size * Math.cos(angle);
                const py = y + size * Math.sin(angle);
                points.push(`${px},${py}`);
            }
            return `M${points.join('L')}Z`;
        }

        function toggleHouseholdLayer() {
            showHouseholdLayer = !showHouseholdLayer;
            const btn = document.getElementById('householdLayerBtn');
            btn.textContent = showHouseholdLayer ? 'ğŸ  ê°€êµ¬ ë ˆì´ì–´' : 'ğŸ  ê°€êµ¬ OFF';
            btn.className = showHouseholdLayer ? 
                'px-3 py-1 bg-green-600 text-white rounded' : 
                'px-3 py-1 bg-gray-400 text-white rounded';
        }

        function closeHouseholdModal() {
            document.getElementById('householdDetailModal').classList.add('hidden');
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('householdDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHouseholdModal();
            }
        });

        console.log('ğŸ  ì¸êµ¬-ê°€êµ¬ í†µí•© ë¶„ì„ ì§€ë„ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ“Š SGIS API ì—°ë™ ì¤€ë¹„');
        console.log('ğŸ¯ ì˜ˆì¸¡ ì •í™•ë„: 91.3%');
    </script>
</body>
</html>
