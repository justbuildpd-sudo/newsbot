<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³„ì¸µì  ì§€ë„ ì‹œìŠ¤í…œ - 4ë‹¨ê³„ ë“œë¦´ë‹¤ìš´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .map-container {
            position: relative;
            width: 100%;
            height: 600px;
        }
        .hex-region {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .hex-region:hover {
            filter: brightness(1.2);
            transform: scale(1.05);
        }
        .popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .popup-content {
            background: white;
            border-radius: 12px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .breadcrumb {
            background: linear-gradient(90deg, #3B82F6, #8B5CF6);
            color: white;
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            white-space: nowrap;
        }
        .level-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container mx-auto px-4 py-6">
        <!-- í—¤ë” -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ—ºï¸ ê³„ì¸µì  ì§€ë„ ì‹œìŠ¤í…œ</h1>
            <p class="text-gray-600">ì „êµ­ â†’ ê´‘ì—­ â†’ ê¸°ì´ˆ â†’ í–‰ì •ë™ 4ë‹¨ê³„ ë“œë¦´ë‹¤ìš´ ì§€ë„</p>
            
            <!-- ë„¤ë¹„ê²Œì´ì…˜ ë¸Œë ˆë“œí¬ëŸ¼ -->
            <div id="breadcrumb" class="breadcrumb mt-4 inline-block">
                <span id="breadcrumbContent">ğŸ‡°ğŸ‡· ëŒ€í•œë¯¼êµ­ ì „êµ­</span>
            </div>
        </header>

        <!-- ë ˆë²¨ í‘œì‹œê¸° -->
        <div class="level-indicator" id="levelIndicator">
            Level 1: ì „êµ­ (17ê°œ ì‹œë„)
        </div>

        <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" id="mapTitle">ì „êµ­ ì‹œë„ë³„ í˜„í™©</h2>
                <div class="flex space-x-2">
                    <button onclick="goBack()" id="backBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 hidden">
                        â† ë’¤ë¡œ
                    </button>
                    <button onclick="resetToNational()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ğŸ  ì „êµ­
                    </button>
                </div>
            </div>
            
            <div class="map-container">
                <svg id="mainMapSvg" viewBox="0 0 1200 800" class="w-full h-full border border-gray-200 rounded-lg bg-gray-50">
                    <!-- ë²”ë¡€ -->
                    <g id="mapLegend" transform="translate(20, 20)">
                        <rect x="0" y="0" width="180" height="140" fill="white" stroke="#ccc" stroke-width="1" rx="6" opacity="0.95"/>
                        <text x="90" y="18" text-anchor="middle" class="text-sm font-bold fill-gray-800">ì¸êµ¬ ê·œëª¨</text>
                        
                        <circle cx="15" cy="35" r="6" fill="#1E40AF"/>
                        <text x="25" y="40" class="text-xs fill-gray-700">1000ë§Œ+ (ì´ˆëŒ€í˜•)</text>
                        
                        <circle cx="15" cy="55" r="6" fill="#3B82F6"/>
                        <text x="25" y="60" class="text-xs fill-gray-700">500-1000ë§Œ (ëŒ€í˜•)</text>
                        
                        <circle cx="15" cy="75" r="6" fill="#60A5FA"/>
                        <text x="25" y="80" class="text-xs fill-gray-700">200-500ë§Œ (ì¤‘í˜•)</text>
                        
                        <circle cx="15" cy="95" r="6" fill="#93C5FD"/>
                        <text x="25" y="100" class="text-xs fill-gray-700">100-200ë§Œ (ì†Œí˜•)</text>
                        
                        <circle cx="15" cy="115" r="6" fill="#DBEAFE"/>
                        <text x="25" y="120" class="text-xs fill-gray-700">100ë§Œ ë¯¸ë§Œ (ì†Œê·œëª¨)</text>
                    </g>

                    <!-- ë©”ì¸ ì§€ë„ ì½˜í…ì¸  (ë™ì  ìƒì„±) -->
                    <g id="mapContent"></g>
                </svg>
                
                <div id="tooltip" class="tooltip hidden"></div>
            </div>
        </div>

        <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="currentLevel">1</div>
                <div class="text-sm text-gray-600">í˜„ì¬ ë ˆë²¨</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="totalUnits">17</div>
                <div class="text-sm text-gray-600">ì´ ë‹¨ìœ„</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="selectedUnit">0</div>
                <div class="text-sm text-gray-600">ì„ íƒë¨</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="totalPopulation">51,057,692</div>
                <div class="text-sm text-gray-600">ì´ ì¸êµ¬</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="avgDensity">527</div>
                <div class="text-sm text-gray-600">í‰ê·  ë°€ë„</div>
            </div>
        </div>
    </div>

    <!-- íŒì—… ëª¨ë‹¬ë“¤ -->
    <!-- ê´‘ì—­ ì§€ë„ íŒì—… -->
    <div id="metropolitanPopup" class="popup-modal hidden">
        <div class="popup-content w-4/5 h-4/5">
            <div class="breadcrumb">
                <span id="metroTitle">ê´‘ì—­ ì§€ë„</span>
                <button onclick="closeMetropolitanPopup()" class="float-right text-white hover:text-gray-200 text-xl font-bold">Ã—</button>
            </div>
            <div class="p-6">
                <svg id="metropolitanMapSvg" viewBox="0 0 800 600" class="w-full h-96 border border-gray-200 rounded-lg bg-gray-50">
                    <g id="metroMapContent"></g>
                </svg>
                <div class="mt-4 text-sm text-gray-600">
                    ì‹œêµ°êµ¬ë¥¼ í´ë¦­í•˜ë©´ ê¸°ì´ˆ ì§€ë„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- ê¸°ì´ˆ ì§€ë„ íŒì—… -->
    <div id="localPopup" class="popup-modal hidden">
        <div class="popup-content w-4/5 h-4/5">
            <div class="breadcrumb">
                <span id="localTitle">ê¸°ì´ˆ ì§€ë„</span>
                <button onclick="closeLocalPopup()" class="float-right text-white hover:text-gray-200 text-xl font-bold">Ã—</button>
            </div>
            <div class="p-6">
                <svg id="localMapSvg" viewBox="0 0 800 600" class="w-full h-96 border border-gray-200 rounded-lg bg-gray-50">
                    <g id="localMapContent"></g>
                </svg>
                <div class="mt-4 text-sm text-gray-600">
                    ìë©´ë™ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- ë™ë³„ ìƒì„¸ íŒì—… -->
    <div id="dongDetailPopup" class="popup-modal hidden">
        <div class="popup-content w-3/4 h-3/4">
            <div class="breadcrumb">
                <span id="dongTitle">í–‰ì •ë™ ìƒì„¸</span>
                <button onclick="closeDongPopup()" class="float-right text-white hover:text-gray-200 text-xl font-bold">Ã—</button>
            </div>
            <div id="dongDetailContent" class="p-6">
                <!-- ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <script>
        // ê³„ì¸µì  ì§€ë„ ë°ì´í„°
        const hierarchicalData = {
            // Level 1: ì „êµ­ (17ê°œ ì‹œë„)
            national: {
                level: 1,
                title: "ì „êµ­ ì‹œë„ë³„ í˜„í™©",
                units: [
                    {id: "seoul", name: "ì„œìš¸íŠ¹ë³„ì‹œ", x: 300, y: 150, population: 9720846, districts: 25},
                    {id: "busan", name: "ë¶€ì‚°ê´‘ì—­ì‹œ", x: 900, y: 550, population: 3349016, districts: 18},
                    {id: "daegu", name: "ëŒ€êµ¬ê´‘ì—­ì‹œ", x: 750, y: 450, population: 2410700, districts: 10},
                    {id: "incheon", name: "ì¸ì²œê´‘ì—­ì‹œ", x: 200, y: 200, population: 2954955, districts: 13},
                    {id: "gwangju", name: "ê´‘ì£¼ê´‘ì—­ì‹œ", x: 400, y: 500, population: 1441970, districts: 7},
                    {id: "daejeon", name: "ëŒ€ì „ê´‘ì—­ì‹œ", x: 500, y: 350, population: 1454679, districts: 6},
                    {id: "ulsan", name: "ìš¸ì‚°ê´‘ì—­ì‹œ", x: 850, y: 480, population: 1134225, districts: 5},
                    {id: "sejong", name: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", x: 450, y: 320, population: 373090, districts: 1},
                    {id: "gyeonggi", name: "ê²½ê¸°ë„", x: 350, y: 200, population: 13427014, districts: 60},
                    {id: "gangwon", name: "ê°•ì›íŠ¹ë³„ìì¹˜ë„", x: 650, y: 200, population: 1536270, districts: 8},
                    {id: "chungbuk", name: "ì¶©ì²­ë¶ë„", x: 550, y: 300, population: 1591625, districts: 8},
                    {id: "chungnam", name: "ì¶©ì²­ë‚¨ë„", x: 400, y: 320, population: 2118930, districts: 11},
                    {id: "jeonbuk", name: "ì „ë¶íŠ¹ë³„ìì¹˜ë„", x: 450, y: 420, population: 1792476, districts: 10},
                    {id: "jeonnam", name: "ì „ë¼ë‚¨ë„", x: 400, y: 550, population: 1856473, districts: 12},
                    {id: "gyeongbuk", name: "ê²½ìƒë¶ë„", x: 700, y: 350, population: 2660941, districts: 13},
                    {id: "gyeongnam", name: "ê²½ìƒë‚¨ë„", x: 750, y: 520, population: 3347727, districts: 16},
                    {id: "jeju", name: "ì œì£¼íŠ¹ë³„ìì¹˜ë„", x: 300, y: 720, population: 672948, districts: 2}
                ]
            },
            
            // Level 2: ê´‘ì—­ ë‚´ ì‹œêµ°êµ¬
            metropolitan: {
                seoul: {
                    level: 2,
                    title: "ì„œìš¸íŠ¹ë³„ì‹œ ìì¹˜êµ¬",
                    parent: "ì„œìš¸íŠ¹ë³„ì‹œ",
                    units: [
                        {id: "jongno", name: "ì¢…ë¡œêµ¬", x: 150, y: 100, population: 150000, dong_count: 16},
                        {id: "jung", name: "ì¤‘êµ¬", x: 200, y: 120, population: 130000, dong_count: 15},
                        {id: "seongdong", name: "ì„±ë™êµ¬", x: 250, y: 110, population: 290000, dong_count: 17},
                        {id: "gwangjin", name: "ê´‘ì§„êµ¬", x: 300, y: 100, population: 350000, dong_count: 15},
                        {id: "dongdaemun", name: "ë™ëŒ€ë¬¸êµ¬", x: 180, y: 80, population: 340000, dong_count: 14},
                        {id: "seongbuk", name: "ì„±ë¶êµ¬", x: 160, y: 60, population: 420000, dong_count: 20},
                        {id: "dobong", name: "ë„ë´‰êµ¬", x: 140, y: 40, population: 320000, dong_count: 8},
                        {id: "nowon", name: "ë…¸ì›êµ¬", x: 200, y: 20, population: 540000, dong_count: 19},
                        {id: "gangnam", name: "ê°•ë‚¨êµ¬", x: 320, y: 200, population: 540000, dong_count: 22},
                        {id: "seocho", name: "ì„œì´ˆêµ¬", x: 280, y: 220, population: 400000, dong_count: 18},
                        {id: "songpa", name: "ì†¡íŒŒêµ¬", x: 360, y: 190, population: 660000, dong_count: 28},
                        {id: "gangdong", name: "ê°•ë™êµ¬", x: 400, y: 180, population: 440000, dong_count: 24}
                    ]
                },
                gyeonggi: {
                    level: 2,
                    title: "ê²½ê¸°ë„ ì‹œêµ°",
                    parent: "ê²½ê¸°ë„",
                    units: [
                        {id: "suwon", name: "ìˆ˜ì›ì‹œ", x: 200, y: 200, population: 1200000, dong_count: 42},
                        {id: "seongnam", name: "ì„±ë‚¨ì‹œ", x: 250, y: 180, population: 950000, dong_count: 50},
                        {id: "goyang", name: "ê³ ì–‘ì‹œ", x: 150, y: 120, population: 1070000, dong_count: 35},
                        {id: "yongin", name: "ìš©ì¸ì‹œ", x: 280, y: 220, population: 1080000, dong_count: 38},
                        {id: "bucheon", name: "ë¶€ì²œì‹œ", x: 120, y: 160, population: 820000, dong_count: 32},
                        {id: "ansan", name: "ì•ˆì‚°ì‹œ", x: 100, y: 200, population: 650000, dong_count: 25},
                        {id: "anyang", name: "ì•ˆì–‘ì‹œ", x: 180, y: 190, population: 560000, dong_count: 31},
                        {id: "namyangju", name: "ë‚¨ì–‘ì£¼ì‹œ", x: 320, y: 140, population: 720000, dong_count: 27},
                        {id: "hwaseong", name: "í™”ì„±ì‹œ", x: 150, y: 250, population: 920000, dong_count: 29},
                        {id: "pyeongtaek", name: "í‰íƒì‹œ", x: 200, y: 280, population: 580000, dong_count: 14}
                    ]
                }
            },
            
            // Level 3: ì‹œêµ°êµ¬ ë‚´ ìë©´ë™
            local: {
                gangnam: {
                    level: 3,
                    title: "ê°•ë‚¨êµ¬ í–‰ì •ë™",
                    parent: "ì„œìš¸íŠ¹ë³„ì‹œ > ê°•ë‚¨êµ¬",
                    units: [
                        {id: "sinsa", name: "ì‹ ì‚¬ë™", x: 150, y: 100, population: 25000, characteristics: "ê³ ê¸‰ì£¼ê±°"},
                        {id: "nonhyeon", name: "ë…¼í˜„ë™", x: 200, y: 120, population: 28000, characteristics: "ìƒì—…ì§€ì—­"},
                        {id: "apgujeong", name: "ì••êµ¬ì •ë™", x: 250, y: 110, population: 32000, characteristics: "ë¶€ì´Œ"},
                        {id: "cheongdam", name: "ì²­ë‹´ë™", x: 300, y: 130, population: 22000, characteristics: "ê³ ê¸‰ìƒì—…"},
                        {id: "samsung", name: "ì‚¼ì„±ë™", x: 180, y: 180, population: 35000, characteristics: "ì—…ë¬´ì§€êµ¬"},
                        {id: "daechi", name: "ëŒ€ì¹˜ë™", x: 250, y: 200, population: 45000, characteristics: "êµìœ¡íŠ¹êµ¬"},
                        {id: "yeoksam", name: "ì—­ì‚¼ë™", x: 120, y: 160, population: 38000, characteristics: "ì—…ë¬´ì¤‘ì‹¬"},
                        {id: "dogok", name: "ë„ê³¡ë™", x: 320, y: 180, population: 28000, characteristics: "ì£¼ê±°ì§€ì—­"},
                        {id: "gaepo", name: "ê°œí¬ë™", x: 280, y: 240, population: 42000, characteristics: "ì•„íŒŒíŠ¸ë‹¨ì§€"}
                    ]
                },
                suwon: {
                    level: 3,
                    title: "ìˆ˜ì›ì‹œ í–‰ì •ë™",
                    parent: "ê²½ê¸°ë„ > ìˆ˜ì›ì‹œ",
                    units: [
                        {id: "paldal", name: "íŒ”ë‹¬êµ¬", x: 200, y: 150, population: 200000, characteristics: "êµ¬ë„ì‹¬"},
                        {id: "yeongtong", name: "ì˜í†µêµ¬", x: 250, y: 180, population: 350000, characteristics: "ì‹ ë„ì‹œ"},
                        {id: "jangan", name: "ì¥ì•ˆêµ¬", x: 150, y: 120, population: 300000, characteristics: "ì£¼ê±°ì¤‘ì‹¬"},
                        {id: "gwonseon", name: "ê¶Œì„ êµ¬", x: 280, y: 200, population: 350000, characteristics: "í˜¼í•©ì§€ì—­"}
                    ]
                }
            }
        };

        let currentLevel = 1;
        let currentPath = [];
        let selectedRegion = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ê³„ì¸µì  ì§€ë„ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
            initializeNationalMap();
        });

        function initializeNationalMap() {
            currentLevel = 1;
            currentPath = [];
            
            const svg = d3.select("#mainMapSvg");
            const content = svg.select("#mapContent");
            content.selectAll("*").remove();
            
            // ì „êµ­ ì‹œë„ ìœ¡ê°í˜• ìƒì„±
            const nationalData = hierarchicalData.national;
            
            nationalData.units.forEach(region => {
                const hexSize = Math.max(20, Math.min(40, Math.log(region.population) * 3));
                const hexPath = createHexPath(region.x, region.y, hexSize);
                
                const group = content.append("g")
                    .attr("class", "hex-region")
                    .attr("data-region-id", region.id);
                
                // ìœ¡ê°í˜•
                group.append("path")
                    .attr("d", hexPath)
                    .attr("fill", getPopulationColor(region.population))
                    .attr("stroke", "#374151")
                    .attr("stroke-width", "2")
                    .on("click", () => drillDownToMetropolitan(region))
                    .on("mouseenter", (event) => showRegionTooltip(event, region))
                    .on("mouseleave", hideTooltip);
                
                // ì§€ì—­ëª…
                group.append("text")
                    .attr("x", region.x)
                    .attr("y", region.y - 5)
                    .attr("text-anchor", "middle")
                    .attr("class", "text-xs font-bold fill-white")
                    .style("text-shadow", "1px 1px 1px rgba(0,0,0,0.7)")
                    .text(region.name.replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„|ë„/g, ''));
                
                // ì¸êµ¬ìˆ˜
                group.append("text")
                    .attr("x", region.x)
                    .attr("y", region.y + 8)
                    .attr("text-anchor", "middle")
                    .attr("class", "text-xs fill-white")
                    .style("text-shadow", "1px 1px 1px rgba(0,0,0,0.7)")
                    .text((region.population / 10000).toFixed(0) + 'ë§Œ');
            });
            
            updateLevelIndicator(1, "ì „êµ­", 17);
            updateBreadcrumb("ğŸ‡°ğŸ‡· ëŒ€í•œë¯¼êµ­ ì „êµ­");
        }

        function drillDownToMetropolitan(region) {
            console.log(`ğŸ” ${region.name} ê´‘ì—­ ì§€ë„ë¡œ ë“œë¦´ë‹¤ìš´`);
            
            currentPath.push({level: 1, region: region});
            selectedRegion = region;
            
            // ê´‘ì—­ ì§€ë„ ë°ì´í„° í™•ì¸
            const metroData = hierarchicalData.metropolitan[region.id];
            if (!metroData) {
                alert(`${region.name}ì˜ ìƒì„¸ ì§€ë„ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            // ê´‘ì—­ íŒì—… í‘œì‹œ
            showMetropolitanPopup(region, metroData);
        }

        function showMetropolitanPopup(region, metroData) {
            const popup = document.getElementById('metropolitanPopup');
            const title = document.getElementById('metroTitle');
            
            title.textContent = metroData.title;
            
            // ê´‘ì—­ ì§€ë„ ìƒì„±
            const svg = d3.select("#metropolitanMapSvg");
            const content = svg.select("#metroMapContent");
            content.selectAll("*").remove();
            
            metroData.units.forEach(district => {
                const hexSize = Math.max(15, Math.min(25, Math.log(district.population) * 2));
                const hexPath = createHexPath(district.x, district.y, hexSize);
                
                const group = content.append("g")
                    .attr("class", "district-hex")
                    .attr("data-district-id", district.id);
                
                group.append("path")
                    .attr("d", hexPath)
                    .attr("fill", getPopulationColor(district.population))
                    .attr("stroke", "#374151")
                    .attr("stroke-width", "1.5")
                    .attr("class", "cursor-pointer hover:opacity-80")
                    .on("click", () => drillDownToLocal(district))
                    .on("mouseenter", (event) => showDistrictTooltip(event, district))
                    .on("mouseleave", hideTooltip);
                
                group.append("text")
                    .attr("x", district.x)
                    .attr("y", district.y)
                    .attr("text-anchor", "middle")
                    .attr("class", "text-xs font-bold fill-white pointer-events-none")
                    .style("text-shadow", "1px 1px 1px rgba(0,0,0,0.7)")
                    .text(district.name.replace(/êµ¬|ì‹œ|êµ°/g, ''));
            });
            
            popup.classList.remove('hidden');
            updateLevelIndicator(2, metroData.title, metroData.units.length);
        }

        function drillDownToLocal(district) {
            console.log(`ğŸ” ${district.name} ê¸°ì´ˆ ì§€ë„ë¡œ ë“œë¦´ë‹¤ìš´`);
            
            currentPath.push({level: 2, district: district});
            
            // ê¸°ì´ˆ ì§€ë„ ë°ì´í„° í™•ì¸
            const localData = hierarchicalData.local[district.id];
            if (!localData) {
                alert(`${district.name}ì˜ ìƒì„¸ ì§€ë„ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            closeMetropolitanPopup();
            showLocalPopup(district, localData);
        }

        function showLocalPopup(district, localData) {
            const popup = document.getElementById('localPopup');
            const title = document.getElementById('localTitle');
            
            title.textContent = localData.title;
            
            // ê¸°ì´ˆ ì§€ë„ ìƒì„±
            const svg = d3.select("#localMapSvg");
            const content = svg.select("#localMapContent");
            content.selectAll("*").remove();
            
            localData.units.forEach(dong => {
                const circle = content.append("circle")
                    .attr("cx", dong.x)
                    .attr("cy", dong.y)
                    .attr("r", Math.max(8, Math.min(15, Math.log(dong.population) * 1.5)))
                    .attr("fill", getPopulationColor(dong.population))
                    .attr("stroke", "#374151")
                    .attr("stroke-width", "1")
                    .attr("class", "cursor-pointer hover:opacity-80")
                    .on("click", () => showDongDetail(dong))
                    .on("mouseenter", (event) => showDongTooltip(event, dong))
                    .on("mouseleave", hideTooltip);
                
                content.append("text")
                    .attr("x", dong.x)
                    .attr("y", dong.y + 25)
                    .attr("text-anchor", "middle")
                    .attr("class", "text-xs fill-gray-700")
                    .text(dong.name);
            });
            
            popup.classList.remove('hidden');
            updateLevelIndicator(3, localData.title, localData.units.length);
        }

        function showDongDetail(dong) {
            console.log(`ğŸ“ ${dong.name} ìƒì„¸ ì •ë³´ í‘œì‹œ`);
            
            closeLocalPopup();
            
            const popup = document.getElementById('dongDetailPopup');
            const title = document.getElementById('dongTitle');
            const content = document.getElementById('dongDetailContent');
            
            title.textContent = `${dong.name} ìƒì„¸ ë¶„ì„`;
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600">${dong.population.toLocaleString()}</div>
                            <div class="text-blue-800 font-medium">ì´ ì¸êµ¬</div>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600">${(dong.population / 1000).toFixed(1)}K</div>
                            <div class="text-green-800 font-medium">ì¸êµ¬ ë°€ë„</div>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-lg text-center">
                            <div class="text-3xl font-bold text-purple-600">${dong.characteristics}</div>
                            <div class="text-purple-800 font-medium">ì§€ì—­ íŠ¹ì„±</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ 2014-2025ë…„ ì¸êµ¬ ë³€í™” ì‹œë®¬ë ˆì´ì…˜</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            ${Array.from({length: 12}, (_, i) => {
                                const year = 2014 + i;
                                const simulatedPop = dong.population + Math.floor(Math.random() * 10000 - 5000);
                                const changeRate = (Math.random() * 6 - 3).toFixed(1);
                                return `
                                    <div class="bg-white p-3 rounded border">
                                        <div class="font-medium">${year}ë…„</div>
                                        <div>${simulatedPop.toLocaleString()}ëª…</div>
                                        <div class="${changeRate > 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${changeRate > 0 ? '+' : ''}${changeRate}%
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">ğŸ—³ï¸ ì„ ê±° ì˜í–¥ ë¶„ì„</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="font-medium mb-2">ì¸êµ¬í•™ì  ìš”ì¸</div>
                                <ul class="text-sm space-y-1">
                                    <li>â€¢ ì¸êµ¬ ì•ˆì •ì„±: ë†’ìŒ</li>
                                    <li>â€¢ ì—°ë ¹ êµ¬ì¡°: ì¤‘ì¥ë…„ ì¤‘ì‹¬</li>
                                    <li>â€¢ ê²½ì œ ìˆ˜ì¤€: ìƒìœ„</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-medium mb-2">ì˜ˆì¸¡ ê²°ê³¼</div>
                                <ul class="text-sm space-y-1">
                                    <li>â€¢ íˆ¬í‘œìœ¨: 75%+ ì˜ˆìƒ</li>
                                    <li>â€¢ ì •ì¹˜ ì„±í–¥: ë³´ìˆ˜ ìš°ì„¸</li>
                                    <li>â€¢ ë³€ë™ì„±: ë‚®ìŒ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            popup.classList.remove('hidden');
            updateLevelIndicator(4, `${dong.name} ìƒì„¸`, 1);
        }

        function createHexPath(x, y, size) {
            const points = [];
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i;
                const px = x + size * Math.cos(angle);
                const py = y + size * Math.sin(angle);
                points.push(`${px},${py}`);
            }
            return `M${points.join('L')}Z`;
        }

        function getPopulationColor(population) {
            if (population > 10000000) return '#1E40AF';      // ì´ˆëŒ€í˜• (1000ë§Œ+)
            if (population > 5000000) return '#3B82F6';       // ëŒ€í˜• (500-1000ë§Œ)
            if (population > 2000000) return '#60A5FA';       // ì¤‘í˜• (200-500ë§Œ)
            if (population > 1000000) return '#93C5FD';       // ì†Œí˜• (100-200ë§Œ)
            if (population > 500000) return '#DBEAFE';        // ì†Œê·œëª¨ (50-100ë§Œ)
            return '#F1F5F9';                                 // ë¯¸ë‹ˆ (50ë§Œ ë¯¸ë§Œ)
        }

        function showRegionTooltip(event, region) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div><strong>${region.name}</strong></div>
                <div>ì¸êµ¬: ${region.population.toLocaleString()}ëª…</div>
                <div>ì„ ê±°êµ¬: ${region.districts}ê°œ</div>
                <div>í‰ê· : ${Math.round(region.population / region.districts).toLocaleString()}ëª…/êµ¬</div>
                <div class="text-xs mt-1 opacity-75">í´ë¦­í•˜ì—¬ ê´‘ì—­ ì§€ë„ ë³´ê¸°</div>
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.remove('hidden');
        }

        function showDistrictTooltip(event, district) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div><strong>${district.name}</strong></div>
                <div>ì¸êµ¬: ${district.population.toLocaleString()}ëª…</div>
                <div>í–‰ì •ë™: ${district.dong_count}ê°œ</div>
                <div class="text-xs mt-1 opacity-75">í´ë¦­í•˜ì—¬ ê¸°ì´ˆ ì§€ë„ ë³´ê¸°</div>
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.remove('hidden');
        }

        function showDongTooltip(event, dong) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div><strong>${dong.name}</strong></div>
                <div>ì¸êµ¬: ${dong.population.toLocaleString()}ëª…</div>
                <div>íŠ¹ì„±: ${dong.characteristics}</div>
                <div class="text-xs mt-1 opacity-75">í´ë¦­í•˜ì—¬ ìƒì„¸ ë¶„ì„</div>
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        function updateLevelIndicator(level, title, count) {
            currentLevel = level;
            const indicator = document.getElementById('levelIndicator');
            const levelNames = {1: "ì „êµ­", 2: "ê´‘ì—­", 3: "ê¸°ì´ˆ", 4: "í–‰ì •ë™"};
            
            indicator.textContent = `Level ${level}: ${levelNames[level]} (${count}ê°œ)`;
            
            document.getElementById('currentLevel').textContent = level;
            document.getElementById('totalUnits').textContent = count;
            document.getElementById('mapTitle').textContent = title;
            
            // ë’¤ë¡œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const backBtn = document.getElementById('backBtn');
            if (level > 1) {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }
        }

        function updateBreadcrumb(path) {
            document.getElementById('breadcrumbContent').textContent = path;
        }

        function goBack() {
            if (currentPath.length === 0) return;
            
            const lastLevel = currentPath.pop();
            
            if (currentPath.length === 0) {
                // ì „êµ­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                resetToNational();
            } else {
                // ì´ì „ ë ˆë²¨ë¡œ
                const prevLevel = currentPath[currentPath.length - 1];
                // ì´ì „ ë ˆë²¨ ë³µì› ë¡œì§
            }
        }

        function resetToNational() {
            currentPath = [];
            selectedRegion = null;
            
            // ëª¨ë“  íŒì—… ë‹«ê¸°
            closeAllPopups();
            
            // ì „êµ­ ì§€ë„ ì¬ì´ˆê¸°í™”
            initializeNationalMap();
        }

        function closeMetropolitanPopup() {
            document.getElementById('metropolitanPopup').classList.add('hidden');
        }

        function closeLocalPopup() {
            document.getElementById('localPopup').classList.add('hidden');
        }

        function closeDongPopup() {
            document.getElementById('dongDetailPopup').classList.add('hidden');
        }

        function closeAllPopups() {
            closeMetropolitanPopup();
            closeLocalPopup();
            closeDongPopup();
        }

        // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.querySelectorAll('.popup-modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });

        console.log('ğŸ—ï¸ 4ë‹¨ê³„ ê³„ì¸µì  ì§€ë„ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ“Š Level 1: ì „êµ­ 17ê°œ ì‹œë„');
        console.log('ğŸ“Š Level 2: ê´‘ì—­ ë‚´ ì‹œêµ°êµ¬');
        console.log('ğŸ“Š Level 3: ê¸°ì´ˆ ë‚´ ìë©´ë™');
        console.log('ğŸ“Š Level 4: ë™ë³„ ìƒì„¸ ë¶„ì„');
    </script>
</body>
</html>
